name: Cognito User Pool Feature Discovery

on:
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'

  workflow_dispatch:
    inputs:
      provider_version:
        description: 'AWS Provider version to check (default: latest)'
        required: false
        default: 'latest'
        type: string
      dry_run:
        description: 'Run analysis without creating issues'
        required: false
        default: false
        type: boolean
      force_scan:
        description: 'Force full scan even if no changes detected'
        required: false
        default: false
        type: boolean

# Prevent concurrent executions to avoid race conditions
concurrency:
  group: feature-discovery-${{ github.repository }}
  cancel-in-progress: false

jobs:
  discover-cognito-features:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Minimal permissions following least privilege principle
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        # Pin to specific SHA for supply chain security
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 1

      - name: Validate inputs
        run: |
          set -euo pipefail

          # Validate provider_version input to prevent command injection
          if [[ ! "${{ inputs.provider_version || 'latest' }}" =~ ^(latest|[0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            echo "::error::Invalid provider_version format. Must be 'latest' or semantic version (e.g., '5.82.0')"
            exit 1
          fi

          # Validate boolean inputs
          if [[ "${{ inputs.dry_run }}" != "true" && "${{ inputs.dry_run }}" != "false" ]]; then
            echo "::error::Invalid dry_run value. Must be 'true' or 'false'"
            exit 1
          fi

          if [[ "${{ inputs.force_scan }}" != "true" && "${{ inputs.force_scan }}" != "false" ]]; then
            echo "::error::Invalid force_scan value. Must be 'true' or 'false'"
            exit 1
          fi

          echo "✅ All inputs validated successfully"
          echo "Provider version: ${{ inputs.provider_version || 'latest' }}"
          echo "Dry run mode: ${{ inputs.dry_run }}"
          echo "Force scan: ${{ inputs.force_scan }}"

      - name: Create and validate feature tracker
        run: |
          set -euo pipefail

          mkdir -p .github/feature-tracker

          # Create initial tracker file if it doesn't exist
          if [ ! -f .github/feature-tracker/cognito-features.json ]; then
            # Create temporary file for atomic operation
            cat > .github/feature-tracker/cognito-features.json.tmp << 'EOF'
          {
            "metadata": {
              "module_name": "terraform-aws-cognito-user-pool",
              "last_scan": "1970-01-01T00:00:00Z",
              "provider_version": "0.0.0",
              "scan_count": 0
            },
            "scan_history": [],
            "current_implementation": {
              "resources": {},
              "data_sources": {},
              "examples": {}
            },
            "discovered_features": {
              "new_resources": {},
              "new_arguments": {},
              "new_data_sources": {},
              "deprecated_items": {},
              "bug_fixes": {}
            },
            "issues_created": [],
            "statistics": {
              "total_scans": 0,
              "total_features_discovered": 0,
              "total_issues_created": 0,
              "average_features_per_scan": 0,
              "last_feature_discovery": "never"
            }
          }
          EOF

            # Validate JSON syntax
            if jq empty .github/feature-tracker/cognito-features.json.tmp; then
              # Atomic move to final location
              mv .github/feature-tracker/cognito-features.json.tmp .github/feature-tracker/cognito-features.json
              echo "✅ Created initial feature tracker file with valid JSON"
            else
              echo "::error::Invalid JSON in tracker file template"
              rm -f .github/feature-tracker/cognito-features.json.tmp
              exit 1
            fi
          else
            # Validate existing file
            if ! jq empty .github/feature-tracker/cognito-features.json; then
              echo "::error::Existing feature tracker file contains invalid JSON"
              exit 1
            fi
            echo "✅ Existing feature tracker file validated"
          fi

      - name: Run Claude Code Feature Discovery
        id: claude-discovery
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # MCP Configuration for Terraform and Context7 documentation access
          # Dependencies pinned to specific versions for supply chain security
          mcp_config: |
            {
              "mcpServers": {
                "terraform": {
                  "command": "npx",
                  "args": [
                    "-y",
                    "@modelcontextprotocol/server-terraform@0.6.0"
                  ]
                },
                "context7": {
                  "command": "npx",
                  "args": [
                    "-y",
                    "@upstash/context7-mcp@1.0.0"
                  ]
                }
              }
            }

          # Allow necessary tools for feature discovery
          allowed_tools: |
            mcp__terraform-server__getProviderDocs
            mcp__terraform-server__resolveProviderDocID
            mcp__terraform-server__searchModules
            mcp__terraform-server__moduleDetails
            mcp__context7__resolve-library-id
            mcp__context7__get-library-docs
            Bash(git diff)
            Bash(git status)
            Bash(gh issue create)
            Bash(gh issue list)
            Bash(jq)
            Bash(cat)
            Bash(echo)

          # Direct prompt for Claude Code to perform feature discovery
          direct_prompt: |
            # Cognito User Pool Feature Discovery Analysis

            You are performing automated feature discovery for the terraform-aws-cognito-user-pool module.

            ## Objective
            Analyze the latest AWS provider Cognito resources and compare them with the current module implementation to identify:
            1. **New Features**: Cognito User Pool resources/arguments not yet implemented
            2. **Deprecations**: Features marked as deprecated in the provider
            3. **Bug Fixes**: Important fixes mentioned in provider changelogs

            ## Configuration
            - Provider Version: ${{ inputs.provider_version || 'latest' }}
            - Dry Run Mode: ${{ inputs.dry_run }}
            - Force Scan: ${{ inputs.force_scan }}

            ## Process

            ### Step 1: Load Current State
            Read the feature tracking database:
            ```bash
            cat .github/feature-tracker/cognito-features.json
            ```

            ### Step 2: Fetch AWS Provider Cognito Documentation
            Use the Terraform MCP server to get the latest Cognito documentation:

            1. Use `mcp__terraform-server__resolveProviderDocID` with:
               - providerName: "aws"
               - providerNamespace: "hashicorp"
               - serviceSlug: "cognito"
               - providerVersion: "${{ inputs.provider_version || 'latest' }}"
               - providerDataType: "resources"

            2. Get documentation for all Cognito resources (aws_cognito_*)
            3. Also check data sources with providerDataType: "data-sources"

            ### Step 3: Analyze Current Module Implementation
            Examine these files to understand current implementation:
            - `main.tf` - Primary user pool resource
            - `client.tf` - User pool client configurations
            - `domain.tf` - User pool domain configurations
            - `identity-provider.tf` - Identity provider configurations
            - `resource-server.tf` - Resource server configurations
            - `user-group.tf` - User group configurations
            - `variables.tf` - Input variables
            - `outputs.tf` - Module outputs

            Create an inventory of:
            - Implemented resources (aws_cognito_user_pool, aws_cognito_user_pool_client, etc.)
            - Implemented arguments/attributes on each resource
            - Configuration patterns used in examples

            ### Step 4: Comparison and Analysis
            Compare provider documentation with module implementation:

            **New Features to Look For:**
            - New `aws_cognito_*` resources not in the module
            - New arguments on existing resources (user pool, client, domain, etc.)
            - New data sources (`data.aws_cognito_*`)
            - New authentication flows and security features
            - New MFA and verification options
            - New branding and UI customization features
            - New managed login capabilities

            **Deprecations to Check:**
            - Arguments marked as deprecated
            - Resources marked for removal
            - Authentication flows that are outdated
            - Configuration patterns no longer recommended

            **Bug Fixes:**
            - Check Context7 for AWS provider changelogs
            - Look for Cognito-related fixes that might affect the module

            ### Step 5: Issue Creation
            For each significant finding:

            **If NOT in dry run mode (${{ inputs.dry_run }} == false):**

            Create GitHub issues using templates:

            ```bash
            # For new features
            gh issue create --template .github/ISSUE_TEMPLATE/new-cognito-feature.md \
              --title "feat: Add support for [feature_name]" \
              --label "enhancement,aws-provider-update,auto-discovered" \
              --assignee "@me"

            # For deprecations
            gh issue create --template .github/ISSUE_TEMPLATE/cognito-deprecation.md \
              --title "chore: Handle deprecation of [feature_name]" \
              --label "deprecation,breaking-change,auto-discovered" \
              --assignee "@me"

            # For bug fixes
            gh issue create --template .github/ISSUE_TEMPLATE/cognito-bug-fix.md \
              --title "fix: Address [bug_description]" \
              --label "bug,aws-provider-update,auto-discovered" \
              --assignee "@me"
            ```

            ### Step 6: Update Feature Tracker
            Update `.github/feature-tracker/cognito-features.json` with:
            - Current scan timestamp
            - Provider version analyzed
            - New findings
            - Issues created
            - Scan summary

            ### Step 7: Generate Summary Report
            Create a comprehensive summary including:
            - Features discovered: count and details
            - Deprecations found: count and impact
            - Issues created: numbers and links
            - Recommendations for next steps

            ## Important Notes
            - Skip creating issues for features already tracked as "implemented"
            - Check existing GitHub issues to avoid duplicates
            - Prioritize security and authentication-related changes
            - Focus on Cognito-specific features (ignore general AWS provider changes)
            - Pay special attention to user pool, client, and identity provider configurations
            - Consider MFA, security, and user experience improvements

            ## Expected Output
            Provide a detailed report of your analysis and actions taken.

      - name: Commit feature tracker updates
        if: steps.claude-discovery.conclusion == 'success'
        run: |
          set -euo pipefail

          # Validate JSON before committing
          if ! jq empty .github/feature-tracker/cognito-features.json; then
            echo "::error::Feature tracker JSON is invalid after processing"
            exit 1
          fi

          # Check if there are changes to commit
          if git diff --quiet .github/feature-tracker/; then
            echo "✅ No changes to feature tracker detected"
            exit 0
          fi

          # Configure git with safe defaults
          git config --global user.name "Cognito Feature Discovery Bot"
          git config --global user.email "actions@github.com"

          # Sanitize inputs for commit message (additional security layer)
          PROVIDER_VERSION="${{ inputs.provider_version || 'latest' }}"
          # Remove any potentially dangerous characters
          PROVIDER_VERSION=$(echo "$PROVIDER_VERSION" | tr -cd '[:alnum:].-')

          # Stage changes
          git add .github/feature-tracker/

          # Create commit with sanitized message
          git commit -m "chore: update Cognito User Pool feature discovery tracker

          - Updated feature tracking database
          - Scan completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - Provider version: ${PROVIDER_VERSION}

          [skip ci]"

          # Attempt to push with retry logic
          max_retries=3
          retry_count=0

          while [ $retry_count -lt $max_retries ]; do
            if git push origin HEAD; then
              echo "✅ Feature tracker updated successfully"
              exit 0
            else
              retry_count=$((retry_count + 1))
              if [ $retry_count -lt $max_retries ]; then
                echo "Push failed, retrying in 5 seconds... (attempt $retry_count/$max_retries)"
                sleep 5
                git pull --rebase origin HEAD || echo "Rebase failed, continuing with retry"
              else
                echo "::error::Failed to push after $max_retries attempts"
                exit 1
              fi
            fi
          done

      - name: Workflow Summary
        if: always()
        run: |
          set -euo pipefail

          # Sanitize inputs for display
          PROVIDER_VERSION="${{ inputs.provider_version || 'latest' }}"
          PROVIDER_VERSION=$(echo "$PROVIDER_VERSION" | tr -cd '[:alnum:].-')

          echo "## 🔍 Cognito User Pool Feature Discovery Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Configuration (with sanitized values)
          echo "### ⚙️ Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Provider Version**: \`${PROVIDER_VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run Mode**: \`${{ inputs.dry_run }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Force Scan**: \`${{ inputs.force_scan }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered**: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Security improvements
          echo "### 🔒 Security Features" >> $GITHUB_STEP_SUMMARY
          echo "- **Input Validation**: ✅ Enabled" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependency Pinning**: ✅ MCP servers pinned to specific versions" >> $GITHUB_STEP_SUMMARY
          echo "- **Concurrency Control**: ✅ Race condition prevention active" >> $GITHUB_STEP_SUMMARY
          echo "- **JSON Validation**: ✅ Atomic operations with validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # MCP Configuration (showing pinned versions)
          echo "### 🔗 MCP Servers" >> $GITHUB_STEP_SUMMARY
          echo "- **Terraform MCP**: \`@modelcontextprotocol/server-terraform@0.6.0\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Context7 MCP**: \`@upstash/context7-mcp@1.0.0\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Status
          echo "### 📊 Execution Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.claude-discovery.conclusion }}" = "success" ]; then
            echo "- ✅ **Feature Discovery**: Completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ **Feature Discovery**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f .github/feature-tracker/cognito-features.json ]; then
            if jq empty .github/feature-tracker/cognito-features.json; then
              echo "- ✅ **JSON Validation**: Feature tracker file is valid" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ **JSON Validation**: Feature tracker file is invalid" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Available Commands
          echo "### 🚀 Manual Execution" >> $GITHUB_STEP_SUMMARY
          echo "Run feature discovery manually:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Standard discovery" >> $GITHUB_STEP_SUMMARY
          echo "gh workflow run feature-discovery.yml" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Dry run mode" >> $GITHUB_STEP_SUMMARY
          echo "gh workflow run feature-discovery.yml -f dry_run=true" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Specific provider version" >> $GITHUB_STEP_SUMMARY
          echo "gh workflow run feature-discovery.yml -f provider_version=5.82.0" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
